---
title: "Poročilo pri predmetu Analiza podatkov s programom R"
author: "Nejc Duščak"
output:
  html_document: default
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
runtime: shiny
---

```{r setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
#source("fontconfig.r", encoding="UTF-8")


# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding="UTF-8")
```

```{r rstudio, echo=FALSE, results='asis'}
# Izris povezave do RStudia na Binderju
source("lib/rstudio.r", encoding="UTF-8")
```

##  Analiza neto plač po svetu

Izbral sem si temo neto plač po svetu. V svoji nalogi bom analiziral kakšne so povprečne neto plače po svetu ter jih analiziral glede na več spremenljivk. Plače bom prav tako primerjal geografsko in jih povezal z BDP-jem te države. Prav tako se mi zdi zanimiva primerjava plače in kriminala. Na koncu pa bom plače primerjal tudi s starostno strukturo prebivalstva. 

## Podatkovni viri

Viri:
  - podatki o povprečni mesečni plači:
      https://www.numbeo.com/cost-of-living/prices_by_country.jsp?displayCurrency=USD&itemId=105
  - podatki o življenjskih stroških:
      https://www.numbeo.com/cost-of-living/
  - podatki o številu kriminala:
      https://www.numbeo.com/crime/rankings_by_country.jsp
      https://www.worldatlas.com/articles/murder-rates-by-country.html
  - podatki o povprečni starosti:
      https://en.wikipedia.org/wiki/List_of_countries_by_median_age
  - podatki o BDP-ju:
      https://en.wikipedia.org/wiki/List_of_countries_by_GDP_(PPP)_per_capita
  - podatki o izobrazbi:
      http://hdr.undp.org/en/data
      
## Zasnova podatkovnega dela

Prvo bom poiskal povprečno plačo za posamezno države, znotraj vsake države pa bom navedel povprečno plačo moških in žensk oziroma procentualno razliko med povprečno žensko in moško plačo. Tako bodo v prvem stolpcu moje tabele naštete vse države, nato bo sledila povprečna plača in kasneje še razlika med plačama obeh spolov. Prav tako bom poiskal podatke o BDP-ju, kriminalu in starosti prebivalstva, ter jih vključil v tabelo. Na koncu bom poiskal stroške življenja v posamezni državi, kjer bom stroške razdelil na več podskupin in jih tako primerjal s povprečno plačo. 
***

# Obdelava, uvoz in čiščenje podatkov

```{r}
require(dplyr)
require(tidyr)
require(readr)
library(rvest)
library(gsubfn)
library(readr)
library(dplyr)
library(XML)
library(openxlsx)

#Funkcija, ki uvozi exel tabelo
uvoz.izobrazba <- function(tabelaIzobrazba){
  tabelaIzobrazba <- read.xlsx("C:/Users/nejc/Desktop/FMF/Program R/ProjektAPPR/Novi projekt/ProjektAPPR/podatki/Izobrazba.xlsx")
  obdrzistolpec <- c("Country", "2017")
  tabelaIzobrazba <- tabelaIzobrazba[ , obdrzistolpec]
  names(tabelaIzobrazba) <- c("Država", "Indeks izobrazbe")
  return(tabelaIzobrazba)
}

# Funkcija, ki uvozi plače s strani numbeo
uvoz.place <- function(tabelaPlace){
  linkPlace <- "https://www.numbeo.com/cost-of-living/country_price_rankings?displayCurrency=USD&itemId=105"
  stran <- html_session(linkPlace) %>% read_html() %>% as.character()
  stran1 <- gsub("^.*\\(\\[(.*) \\]\\).*$", "\\1", stran)
  stran1 <- strsplit(stran1, split="   ")[[1]]
  drzave <- gsub("^.*'(.*)'.*$", "\\1",stran1)
  cifre=gsub("^.*, (.*)\\].*$", "\\1",stran1)
  tabelaPlace = data.frame(DrŽava=drzave, vrednost=as.numeric(cifre))[seq(3,length(cifre)-2,2),]
  names(tabelaPlace) <- c("Država", "Višina plače v $")
  return(tabelaPlace)
}

# Funkcija, ki uvozi BDP iz wikipedije
uvoz.BDP <- function(tabelaBDP){
  linkBDP <- "https://en.wikipedia.org/wiki/List_of_countries_by_GDP_(PPP)_per_capita#Distorted_GDP-per-capita_for_tax_havens"
  stranBDP <- html_session(linkBDP) %>% read_html()
  tabelaBDP <- stranBDP %>% html_nodes(xpath = "//table[@class='wikitable sortable']") %>%
    .[[2]] %>% html_table(dec= ",")
  tabelaBDP <- tabelaBDP[ , -1]
  names(tabelaBDP) <- c("Država", "Vrednost BDP v $")
  return(tabelaBDP)
}

# Funkcija, ki uvozi povprečno starost iz wikipedije
uvoz.starost <- function(tabelaStarosti){
  linkStarosti <- "https://en.wikipedia.org/wiki/List_of_countries_by_median_age"
  stranStarosti <- html_session(linkStarosti) %>% read_html()
  tabelaStarosti <- stranStarosti %>% html_nodes(xpath = "//table[@class='wikitable sortable']") %>%
    .[[1]] %>% html_table(dec= ",")
  tabelaStarosti <- tabelaStarosti[ , -2]
  names(tabelaStarosti) <- c("Država", "Povprečje let", "Povprečje moških let", "Povprečje ženskih let")
  return(tabelaStarosti)
}

# Funkcija, ki uvozi stopnjo kriminala iz strani numbeo
uvoz.kriminal <- function(tabelaCrimeindex){
  linkCrimeindex <- "https://www.numbeo.com/crime/rankings_by_country.jsp?title=2017"
  stran <- html_session(linkCrimeindex) %>% read_html() %>% as.character()
  stran1 <- gsub("^.*\\(\\[(.*) \\]\\).*$", "\\1", stran)
  stran1 <- strsplit(stran1, split= "   ")[[1]]
  drzave <- gsub("^.*'(.*)'.*$", "\\1", stran1)
  cifre=gsub("^.*, (.*)\\].*$", "\\1",stran1)
  tabelaCrimeindex = data.frame(Država=drzave, Stopnja.kriminala=as.numeric(cifre))[seq(3,length(cifre)-2,2),]
  names(tabelaCrimeindex) <- c("Država", "Stopnja kriminala")
  return(tabelaCrimeindex)
}

# Funkcija, ki uvozi indeks življenjskih stroškov iz strani numbeo
uvoz.zivljenjski.stroski <- function(tabelaCostliving){
  linkCostliving <- "https://www.numbeo.com/cost-of-living/rankings_by_country.jsp?title=2017"
  stran <- html_session(linkCostliving) %>% read_html() %>% as.character()
  stran1 <- gsub("^.*\\(\\[(.*) \\]\\).*$", "\\1", stran)
  stran1 <- strsplit(stran1, split="   ")[[1]]
  drzave <- gsub("^.*'(.*)'.*$", "\\1",stran1)
  cifre=gsub("^.*, (.*)\\].*$", "\\1",stran1)
  tabelaCostliving = data.frame(Drzave=drzave,vrednost=as.numeric(cifre))[seq(3,length(cifre)-2,2),]
  names(tabelaCostliving) <- c("Država", "Življenjski stroški")
  return(tabelaCostliving)
}


uvoz.placeBDP <- function(zdruzenaPlaceBDP){
  zdruzenaPlaceBDP <- uvoz.place()  %>% inner_join(uvoz.BDP(), "Država"="Država")
  return(zdruzenaPlaceBDP)
}

uvoz.placeBDPkriminal <- function(zdruzenaPlaceBDPCrimeindex){
  zdruzenaPlaceBDPCrimeindex <- uvoz.placeBDP() %>% inner_join(uvoz.kriminal(), "Država"="Država")
  return(zdruzenaPlaceBDPCrimeindex)
}


Tabela1 <- uvoz.placeBDPkriminal()
starost <- uvoz.starost()
izobrazba <- uvoz.izobrazba()
```


Uvozil sem nasljednje podatke:
  - povprečne neto mesečne podatke po svetu (HTML)
  - stopnjo kriminala po svetu (HTML)
  - indeks življenjskega stroška (HTML)
Pri vseh treh HTML datotekah sem naletel na težave pri branju podatkov, saj datoteke niso bile zapisane v navadni obliki, zato sem s pomočjo regularnih izrazov izluščil bistvo, ter nardil tabelo.
  - BDP per capita (HTML)
  - povprečna starost prebivalstva po svetu

Podatki se nahajajo v treh tabelah:
 1.Prva tabela se imenuje Tabela1 in sestoji iz združenih tabel povprečne mesečne plače, BDP-ja in stopnje kriminala:
 -'Država': ime države za katero sem poiskal nasljednje podatke
 -'Višina plače v $': kakšna je povprečna mesečna plača v posamezni državi
 -'BDP v $': koliko znaša BDP per capita v posamezni državi
 -'Stopnja kriminala': koliko znaša indeks kriminala v posamezni državi

 2. Druga tabela je tabela, ki predstavlja povprečno starost prebivalstva v posamezni državi:
 -'Država': ime države za katero sem poiskal nasljednje podatke
 -'Povprečje let': koliko znaša povprečna starost prebivalstva v neki državi
 -'Povprečje moških let': koliko znaša povprečna starost moških v neki državi
 -'Povprečje ženskih let': koliko znaša povprečna starost žensk v neki državi
 
 3. Tretja tabela je tabela, ki predstavlja indeks izobrazbe:
 -'Država': ime države za katero sem poiskal nasljednje podatke
 -'Indeks izobrazbe': prikazuje kakšen je indeks posamezne države
 


Spodnji graf prikazuje porazdelitev števila naselij v občinah.

```{r histogram, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Histogram števila naselij v občinah'}
ggplot(obcine, aes(x=naselja)) + geom_histogram() +
  ggtitle("Pogostost števila naselij") + xlab("Število naselij") + ylab("Število občin")
```

***

# Analiza in vizualizacija podatkov

```{r vizualizacija, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
source("vizualizacija/vizualizacija.r", encoding="UTF-8")
```

Spodnji zemljevid prikazuje povprečno velikost družine za vsako občino.

```{r zemljevid, echo=FALSE, fig.align='center', fig.cap='Zemljevid povprečnega števila otrok v družini'}
ggplot() + geom_polygon(data=left_join(zemljevid, povprecja, by=c("OB_UIME"="obcina")),
                        aes(x=long, y=lat, group=group, fill=povprecje)) +
  ggtitle("Povprečno število otrok v družini") + xlab("") + ylab("") +
  guides(fill=guide_colorbar(title="Povprečje"))
```

***

# Napredna analiza podatkov

```{r analiza, echo=FALSE, message=FALSE}
source("analiza/analiza.r", encoding="UTF-8")
```

Spodnji graf prikazuje povezavo med številom naselij in površino občine.

```{r graf, echo=FALSE, fig.align='center', fig.cap='Povezava med številom naselij in površino občine'}
ggplot(inner_join(obcine, data.frame(obcina=names(skupine),
                                     skupina=factor(skupine)), by="obcina")
, aes(x=povrsina, y=naselja, color=skupina, size=prebivalci/1000)) + geom_point() +
  ggtitle("Število naselij glede na površino občine") +
  xlab(expression("Površina (km"^2 * ")")) + ylab("Št. naselij") +
  guides(color=guide_legend(title="Skupina"),
         size=guide_legend(title="Prebivalci (* 1000)"))
```

***

```{r shiny, echo=FALSE}
shinyAppDir("shiny", options=list(width="100%", height=600))
```
